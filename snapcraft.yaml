# -*- Mode: YAML; indent-tabs-mode: nil; tab-width: 2 -*-
#
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: Michael Terry
---
name: deja-dup
license: GPL-3.0+

# Disabled for now - store caught our builds in manual review because of the
# unexpected 'links' attribute in the resulting snap.yml
#website: https://wiki.gnome.org/Apps/DejaDup
#source-code:
#  - https://gitlab.gnome.org/World/deja-dup.git
#  - https://github.com/deja-dup/snap.git
#issues: https://gitlab.gnome.org/World/deja-dup/-/issues
#donation: https://liberapay.com/DejaDup
#contact:
#  - https://discourse.gnome.org/tags/c/applications/7/deja-dup
#  - https://matrix.to/#/#deja-dup:gnome.org

grade: stable
confinement: classic
base: core20
adopt-info: deja-dup
assumes: [command-chain]

# - Could point python at core20 instead of bundling it in.
# - Could bundle gnome into ourselves and chop it up

# Hooks:
# hooks-configure-desktop comes from fonts

apps:
  deja-dup:
    adapter: full
    command-chain: [bin/desktop-launch, wrapper]
    command: usr/bin/deja-dup
    common-id: org.gnome.DejaDup
    #environment:
    #  SNAP_DESKTOP_RUNTIME: $SNAP/gnome-platform

  monitor:
    adapter: full
    command-chain: [bin/desktop-launch, wrapper]
    command: usr/libexec/deja-dup/deja-dup-monitor
    autostart: org.gnome.DejaDup.Monitor.desktop

plugs:
  gnome-3-38-2004:
    interface: content
    target: $SNAP/gnome-platform # not actually mounted, because of classic mode
    default-provider: gnome-3-38-2004

parts:
  dump:
    plugin: dump
    source: ./local

  duplicity:
    plugin: python
    constraints:
      - ${SNAPCRAFT_PROJECT_DIR}/constraints.txt
    python-packages:
      - duplicity
      - pydrive2
      - pygobject
    build-packages:
      - cargo # to build cryptography
      - libgirepository1.0-dev
      - librsync-dev
      - libssl-dev
      - rustc # to build cryptography
    stage-packages:
      - gpg
      - libgirepository-1.0-1
      - librsync2
    prime:
      - -bin/python
      - -bin/python3

  libhandy:
    plugin: meson
    source: https://gitlab.gnome.org/GNOME/libhandy.git
    source-type: git
    source-tag: 1.0.3
    meson-parameters:
      - -Dexamples=false
      - -Dtests=false

  deja-dup:
    after: [libhandy]
    plugin: meson
    source: https://gitlab.gnome.org/World/deja-dup.git
    source-type: git
    source-branch: '42'
    meson-parameters:
      - --buildtype=release
      - --prefix=/snap/deja-dup/current/usr
    parse-info: [usr/share/metainfo/org.gnome.DejaDup.appdata.xml]
    organize:
      snap/deja-dup/current: .
    build-environment:
      # To find libhandy-1.vapi
      - XDG_DATA_DIRS: "/usr/share:$SNAPCRAFT_STAGE/usr/local/share"
    build-packages:
      - gettext
      - itstool
      - libglib2.0-bin
      - libglib2.0-dev
      - libgpg-error-dev
      - libgtk-3-dev
      - libjson-glib-dev
      - libsecret-1-dev
      - libsoup2.4-dev
      - valac
    stage-packages:
      - gvfs-backends
      - libgtk-3-0
      - libjson-glib-1.0-0
      - libsecret-1-0
      - libsoup2.4-1
    override-pull: |
      snapcraftctl pull
      patch -p1 -N < ${SNAPCRAFT_PROJECT_DIR}/no-help.diff
    override-prime: |
      snapcraftctl prime
      sed -i 's|Icon=.*|Icon=${SNAP}/usr/share/icons/hicolor/scalable/apps/org.gnome.DejaDup.svg|' usr/share/applications/org.gnome.DejaDup.desktop

  # Done separately because the other parts freaks out if we try to stage python
  python:
    plugin: nil
    after: [duplicity, deja-dup]
    stage-packages:
      - libpython3.8-minimal
      - libpython3.8-stdlib
      - python3-minimal
      - python3.8-minimal


  desktop-gtk3:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: gtk
    plugin: make
    make-parameters:
      - FLAVOR=gtk3
    build-packages:
      - libgtk-3-dev
    stage-packages:
      - libxkbcommon0  # XKB_CONFIG_ROOT
      - ttf-ubuntu-font-family
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - gnome-themes-standard
      - shared-mime-info
      - libgtk-3-0
      - libgdk-pixbuf2.0-0
      - libglib2.0-bin
      - libgtk-3-bin
      - unity-gtk3-module
      - libappindicator3-1
      - locales-all
      - xdg-user-dirs
      - ibus-gtk3
      - libibus-1.0-5
    override-prime: |
      snapcraftctl prime
      # these scripts want to run several commands (like compiling gsettings, gio modules)
      # from our extension runtime, but we don't have one - so use copies from core instead
      cp -r "/snap/core20/current/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/glib-2.0" "usr/lib/$SNAPCRAFT_ARCH_TRIPLET"
